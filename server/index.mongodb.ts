// ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ MongoDB
import express, { type Request, Response, NextFunction } from "express";
import { connectToMongoDB } from "./db/mongodb.js";
import { registerRoutes } from "./routes";

const app = express();

// ... Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Express ...

(async () => {
  try {
    // ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB
    console.log('ðŸ”Œ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB...');
    await connectToMongoDB();
    console.log('âœ… MongoDB Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°');

    // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð² (Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ)
    const { UserRepositoryMongo } = await import('./repositories/user.repository.mongo.js');
    const userRepo = new UserRepositoryMongo();
    await userRepo.createIndexes();
    console.log('âœ… Ð˜Ð½Ð´ÐµÐºÑÑ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹');

    // Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ñ€Ð¾ÑƒÑ‚Ð¾Ð²
    await registerRoutes(httpServer, app);

    // Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
    const port = parseInt(process.env.PORT || "5000", 10);
    httpServer.listen(port, () => {
      console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${port}`);
    });

  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ ÑÐµÑ€Ð²ÐµÑ€Ð°:', error);
    process.exit(1);
  }
})();

// Graceful shutdown
process.on('SIGINT', async () => {
  const { closeMongoDB } = await import('./db/mongodb.js');
  await closeMongoDB();
  process.exit(0);
});

