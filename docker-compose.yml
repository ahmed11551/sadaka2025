services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: sadakapass-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: sadakapass
      MONGO_INITDB_ROOT_PASSWORD: sadakapass_password
      MONGO_INITDB_DATABASE: sadaka2025
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sadakapass-network

  # Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sadakapass-app
    environment:
      NODE_ENV: production
      PORT: 5000
      MONGODB_URI: mongodb://sadakapass:sadakapass_password@mongodb:27017/sadaka2025?authSource=admin
      SESSION_SECRET: ${SESSION_SECRET:-change-this-in-production}
      API_BASE_URL: ${API_BASE_URL:-https://bot.e-replika.ru/api/v1}
      API_TOKEN: ${API_TOKEN:-test_token_123}
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:5000/api}
      VITE_API_TOKEN: ${VITE_API_TOKEN:-test_token_123}
      VITE_INSAN_API_URL: ${VITE_INSAN_API_URL:-https://fondinsan.ru/api/v1}
      VITE_INSAN_ACCESS_TOKEN: ${VITE_INSAN_ACCESS_TOKEN:-}
    ports:
      - "5001:5000"
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Waiting for MongoDB...' &&
        sleep 5 &&
        echo 'Starting server...' &&
        node dist/index.cjs
      "
    networks:
      - sadakapass-network
    restart: unless-stopped

volumes:
  mongodb_data:

networks:
  sadakapass-network:
    driver: bridge

