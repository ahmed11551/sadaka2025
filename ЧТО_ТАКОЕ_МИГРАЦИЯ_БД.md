# –ß—Ç–æ —Ç–∞–∫–æ–µ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î –∏ –∑–∞—á–µ–º –æ–Ω–∞ –Ω—É–∂–Ω–∞

## üìö –ß—Ç–æ —Ç–∞–∫–æ–µ –º–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?

**–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** ‚Äî —ç—Ç–æ –Ω–∞–±–æ—Ä SQL –∫–æ–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω—è—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
- –î–æ–±–∞–≤–ª—è—é—Ç –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- –î–æ–±–∞–≤–ª—è—é—Ç –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
- –°–æ–∑–¥–∞—é—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

## üéØ –ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–∞—à–∞ –º–∏–≥—Ä–∞—Ü–∏—è?

–§–∞–π–ª `prisma/migrations/add_new_features.sql` –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏:

### 1. **–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** (User roles)
```sql
ALTER TABLE "users" ADD COLUMN "role" TEXT DEFAULT 'user';
```
**–ó–∞—á–µ–º**: –ß—Ç–æ–±—ã —Ä–∞–∑–ª–∏—á–∞—Ç—å –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, –º–æ–¥–µ—Ä–∞—Ü–∏—è –∫–∞–º–ø–∞–Ω–∏–π

---

### 2. **–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–∞–º–ø–∞–Ω–∏–π** (Campaign moderation)
```sql
ALTER TABLE "campaigns" ADD COLUMN "moderationStatus" TEXT DEFAULT 'pending';
ALTER TABLE "campaigns" ADD COLUMN "moderationNote" TEXT;
ALTER TABLE "campaigns" ADD COLUMN "moderatedAt" TIMESTAMP;
ALTER TABLE "campaigns" ADD COLUMN "moderatedBy" TEXT;
```
**–ó–∞—á–µ–º**: –ß—Ç–æ–±—ã –Ω–æ–≤—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: 
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/admin/campaigns` –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
- –ù–æ–≤—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Å—Ç–∞—Ç—É—Å `pending`

---

### 3. **–¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π** (Payments table)
```sql
CREATE TABLE "payments" (
    "id" TEXT PRIMARY KEY,
    "donationId" TEXT UNIQUE,
    "provider" TEXT, -- "yookassa" –∏–ª–∏ "cloudpayments"
    "amount" DECIMAL(15, 2),
    "status" TEXT, -- "pending", "succeeded", "failed"
    ...
);
```
**–ó–∞—á–µ–º**: –•—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–∞—Ö —á–µ—Ä–µ–∑ YooKassa –∏ CloudPayments

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: 
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≤ `DonationModal`
- Webhooks –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —à–ª—é–∑–æ–≤
- –°—Ç—Ä–∞–Ω–∏—Ü—ã `/payment/success` –∏ `/payment/failed`

---

### 4. **–†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫** (Subscription recurring payments)
```sql
ALTER TABLE "subscriptions" ADD COLUMN "providerToken" TEXT;
ALTER TABLE "subscriptions" ADD COLUMN "lastChargeDate" TIMESTAMP;
ALTER TABLE "subscriptions" ADD COLUMN "chargeAttempts" INTEGER;
```
**–ó–∞—á–µ–º**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ (—Å–∞–¥–∞–∫–∞-–¥–∂–∞—Ä–∏—è)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: 
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü/–∫–≤–∞—Ä—Ç–∞–ª/–≥–æ–¥
- Cron job `subscription-charges.ts`

---

### 5. **–¢–∞–±–ª–∏—Ü–∞ –æ—Ç—á—ë—Ç–æ–≤** (Reports table)
```sql
CREATE TABLE "reports" (
    "id" TEXT PRIMARY KEY,
    "fundId" TEXT,
    "periodStart" TIMESTAMP,
    "periodEnd" TIMESTAMP,
    "totalCollected" DECIMAL(15, 2),
    ...
);
```
**–ó–∞—á–µ–º**: –•—Ä–∞–Ω–∏—Ç—å –æ—Ç—á—ë—Ç—ã —Ñ–æ–Ω–¥–æ–≤ –æ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: 
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/history` —Å –æ—Ç—á—ë—Ç–∞–º–∏
- –≠–∫—Å–ø–æ—Ä—Ç CSV/PDF –æ—Ç—á—ë—Ç–æ–≤

---

### 6. **–¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—á—ë—Ç–æ–≤ –∑–∞–∫—è—Ç–∞** (Zakat calculations table)
```sql
CREATE TABLE "zakat_calculations" (
    "id" TEXT PRIMARY KEY,
    "userId" TEXT,
    "payloadJson" TEXT, -- JSON —Å –≤–≤–µ–¥—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    "zakatDue" DECIMAL(15, 2), -- –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫—è—Ç–∞
    "aboveNisab" BOOLEAN,
    ...
);
```
**–ó–∞—á–µ–º**: –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—á—ë—Ç–æ–≤ –∑–∞–∫—è—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: 
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/zakat` - –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞–∫—è—Ç–∞
- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤ —á–µ—Ä–µ–∑ `/api/zakat/history`

---

## üîÑ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏?

**–ë–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏**:
- ‚ùå –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π (—Ç–∞–±–ª–∏—Ü–∞ `payments` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- ‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (–∫–æ–ª–æ–Ω–∫–∞ `moderationStatus` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- ‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –∑–∞–∫—è—Ç–∞ (—Ç–∞–±–ª–∏—Ü–∞ `zakat_calculations` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- ‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ (–∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–æ–≤ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç)

**–° –º–∏–≥—Ä–∞—Ü–∏–µ–π**:
- ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É
- ‚úÖ –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏, –º–æ–¥–µ—Ä–∞—Ü–∏—é, –ø–æ–¥–ø–∏—Å–∫–∏, –∑–∞–∫—è—Ç

---

## üìä –°—Ö–µ–º–∞: –ß—Ç–æ –±—ã–ª–æ ‚Üí –ß—Ç–æ —Å—Ç–∞–ª–æ

### –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏:
```
users (id, email, username, password, ...)
campaigns (id, title, description, goal, ...)
donations (id, amount, userId, campaignId, ...)
subscriptions (id, userId, planType, amount, ...)
```

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```
users (id, email, username, password, ..., role) ‚Üê –ù–û–í–û–ï
campaigns (id, title, ..., moderationStatus, moderationNote, ...) ‚Üê –ù–û–í–û–ï
donations (id, amount, ..., payment) ‚Üê –°–≤—è–∑—å —Å payments
subscriptions (id, ..., providerToken, lastChargeDate, ...) ‚Üê –ù–û–í–û–ï
payments (id, donationId, provider, status, ...) ‚Üê –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê
reports (id, fundId, periodStart, totalCollected, ...) ‚Üê –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê
zakat_calculations (id, userId, zakatDue, ...) ‚Üê –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê
```

---

## üöÄ –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é?

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:
1. **–ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º** –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (–ø–ª–∞—Ç–µ–∂–∏, –º–æ–¥–µ—Ä–∞—Ü–∏—è, –∑–∞–∫—è—Ç)
2. **–ü—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ production** (Vercel, Railway, etc.)
3. **–ü–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞** –Ω–∞ –Ω–æ–≤—É—é –º–∞—à–∏–Ω—É

### –ù–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å:
- –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ (–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ SQL)
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–±–µ–∑ –ø–ª–∞—Ç–µ–∂–µ–π, –º–æ–¥–µ—Ä–∞—Ü–∏–∏)

---

## ‚úÖ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è?

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã payments
SELECT table_name 
FROM information_schema.tables 
WHERE table_name = 'payments';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∫–æ–ª–æ–Ω–∫–∏ role –≤ users
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'users' AND column_name = 'role';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∫–æ–ª–æ–Ω–∫–∏ moderationStatus –≤ campaigns
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'campaigns' AND column_name = 'moderationStatus';
```

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ ‚úÖ  
–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é ‚ùå

---

## üìù –ò—Ç–æ–≥–æ

**–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
- –ü–ª–∞—Ç–µ–∂–∏ (YooKassa/CloudPayments)
- –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–∞–º–ø–∞–Ω–∏–π
- –ü–æ–¥–ø–∏—Å–∫–∏ —Å —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏
- –û—Ç—á—ë—Ç—ã —Ñ–æ–Ω–¥–æ–≤
- –†–∞—Å—á—ë—Ç—ã –∑–∞–∫—è—Ç–∞

**–ë–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏** —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, —Ç–∞–∫ –∫–∞–∫ –≤ –ë–î –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –∏ –∫–æ–ª–æ–Ω–æ–∫.

**–° –º–∏–≥—Ä–∞—Ü–∏–µ–π** –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–∞–∫ –∫–∞–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É.

