# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

–ú–∏–≥—Ä–∞—Ü–∏—è `add_new_features.sql` –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:

1. **–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** (`role` –≤ —Ç–∞–±–ª–∏—Ü–µ `users`)
2. **–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–∞–º–ø–∞–Ω–∏–π** (–ø–æ–ª—è `moderationStatus`, `moderationNote`, `moderatedAt`, `moderatedBy`)
3. **–¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π** (`payments`)
4. **–†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫** (–ø–æ–ª—è `providerId`, `providerToken`, `lastChargeDate`, `chargeAttempts`)
5. **–¢–∞–±–ª–∏—Ü–∞ –æ—Ç—á—ë—Ç–æ–≤** (`reports`)
6. **–¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—á—ë—Ç–æ–≤ –∑–∞–∫—è—Ç–∞** (`zakat_calculations`)

## üöÄ –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Prisma (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –õ–æ–∫–∞–ª—å–Ω–æ (development)

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω DATABASE_URL –≤ .env
npx prisma migrate dev --name add_new_features

# –ò–ª–∏ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é –∏–∑ schema.prisma:
npx prisma migrate dev
```

### Production (Vercel/Railway/etc)

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π
npx prisma migrate deploy

# –ò–ª–∏ —á–µ—Ä–µ–∑ SQL –Ω–∞–ø—Ä—è–º—É—é:
psql $DATABASE_URL < prisma/migrations/add_new_features.sql
```

## üöÄ –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ SQL –Ω–∞–ø—Ä—è–º—É—é

### –õ–æ–∫–∞–ª—å–Ω–æ

```bash
# PostgreSQL
psql -U your_user -d your_database < prisma/migrations/add_new_features.sql

# –ò–ª–∏ —á–µ—Ä–µ–∑ DATABASE_URL
psql $DATABASE_URL < prisma/migrations/add_new_features.sql
```

### Production (—á–µ—Ä–µ–∑ psql –∏–ª–∏ pgAdmin)

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `prisma/migrations/add_new_features.sql`
2. –û—Ç–∫—Ä–æ–π—Ç–µ psql –∏–ª–∏ pgAdmin
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

### –ß–µ—Ä–µ–∑ Vercel Postgres

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Vercel CLI –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å
vercel link
vercel env pull .env.local

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
psql $(vercel env pull DATABASE_URL) < prisma/migrations/add_new_features.sql
```

## üöÄ –°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ Docker

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker:

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ –∑–∞–ø—É—â–µ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker-compose exec postgres psql -U sadakapass -d sadakapass < prisma/migrations/add_new_features.sql

# –ò–ª–∏ —á–µ—Ä–µ–∑ exec –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker-compose exec app npx prisma migrate deploy
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'users' AND column_name = 'role';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∫–∞–º–ø–∞–Ω–∏–π
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'campaigns' AND column_name LIKE 'moderation%';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–ª–∞—Ç–µ–∂–µ–π
SELECT table_name 
FROM information_schema.tables 
WHERE table_name = 'payments';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–∫—è—Ç–∞
SELECT table_name 
FROM information_schema.tables 
WHERE table_name = 'zakat_calculations';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'subscriptions' AND column_name LIKE 'provider%';
```

## üîß –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å:

```sql
-- –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
DROP TABLE IF EXISTS "zakat_calculations";
DROP TABLE IF EXISTS "reports";
DROP TABLE IF EXISTS "payments";

-- –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ subscriptions
ALTER TABLE "subscriptions" DROP COLUMN IF EXISTS "providerId";
ALTER TABLE "subscriptions" DROP COLUMN IF EXISTS "providerToken";
ALTER TABLE "subscriptions" DROP COLUMN IF EXISTS "lastChargeDate";
ALTER TABLE "subscriptions" DROP COLUMN IF EXISTS "chargeAttempts";
ALTER TABLE "subscriptions" DROP COLUMN IF EXISTS "maxChargeAttempts";

-- –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ campaigns
ALTER TABLE "campaigns" DROP COLUMN IF EXISTS "moderationStatus";
ALTER TABLE "campaigns" DROP COLUMN IF EXISTS "moderationNote";
ALTER TABLE "campaigns" DROP COLUMN IF EXISTS "moderatedAt";
ALTER TABLE "campaigns" DROP COLUMN IF EXISTS "moderatedBy";

-- –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –∏–∑ users
ALTER TABLE "users" DROP COLUMN IF EXISTS "role";
```

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **Backup –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–¥–µ–ª–∞–π—Ç–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ production!

2. **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ**: –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:
   - –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ–ª—É—á–∞—Ç —Å—Ç–∞—Ç—É—Å `approved` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—Ç —Ä–æ–ª—å `user` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

3. **–ò–Ω–¥–µ–∫—Å—ã**: –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å `IF NOT EXISTS`, –ø–æ—ç—Ç–æ–º—É –º–∏–≥—Ä–∞—Ü–∏—é –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑

4. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: –í—Å–µ CHECK constraints –∏ foreign keys —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

## üìù –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞**:
   ```sql
   UPDATE "users" SET "role" = 'admin' WHERE email = 'your-admin-email@example.com';
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É**:
   - –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é (–¥–æ–ª–∂–Ω–∞ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å `pending`)
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∑–∞–∫—è—Ç–∞

3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —à–ª—é–∑—ã**:
   - –î–æ–±–∞–≤—å—Ç–µ `YOOKASSA_SHOP_ID` –∏ `YOOKASSA_SECRET_KEY` –≤ env
   - –î–æ–±–∞–≤—å—Ç–µ `CLOUDPAYMENTS_PUBLIC_ID` –∏ `CLOUDPAYMENTS_SECRET_KEY` –≤ env

